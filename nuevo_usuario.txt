
/*Primer borrador del script de creacion de usuario. Faltan muchas cosas, sobre todo variables. Además algunos feeds tienen campos vacíos.
Por otro lado habrá que acoplarlo a los php principales.
También temo que los comwentarios en los procesos de los inputs se carguen la cadena. Basta con liminarlos, pero por si se quieren comprobar.
Hay otro documento con estos procesos, los más complejos
*/




DECLARE @aux_id int;
    
INSERT INTO users (username, password, email, salt, apikey_read, apikey_write, admin ) 
VALUES ('$username' , '$password', '$email', '$salt', '$apikey_read', '$apikey_write', 0 );

SET @aux_id = (SELECT id FROM users WHERE username = '$username' AND password = '$password');

-- Feeds
-- Sin engine con datatype 1
INSERT INTO feeds(name,userid,tag,datatype,public,engine) VALUES ('Potencia FV medida',@aux_id,'Node:','1','0','');
INSERT INTO feeds(name,userid,tag,datatype,public,engine) VALUES ('Potencia FV a cosumo',@aux_id,'Node:','1','0','');
INSERT INTO feeds(name,userid,tag,datatype,public,engine) VALUES ('Potencia Red a consumo', @aux_id, 'Node:', '1','0','');
INSERT INTO feeds(name,userid,tag,datatype,public,engine) VALUES ('Porcentaje de consumo con FV instantaneo', @aux_id, 'Node:', '1','0','');
INSERT INTO feeds(name,userid,tag,datatype,public,engine) VALUES ('Porcentaje de consumo de Red instantaneo',@aux_id,'Node:', '1','0','');
INSERT INTO feeds(name,userid,tag,datatype,public,engine) VALUES ('Potencia FV a Red',@aux_id,'Node:','1','0','');

-- Sin engine con datatype 2
INSERT INTO feeds(name,userid,tag,datatype,public,engine) VALUES ('Energia fotovoltaica diaria',@aux_id,'Node:','2','0','');
INSERT INTO feeds(name,userid,tag,datatype,public,engine) VALUES ('Energia diaria de la red',@aux_id,'Node:','2','0','');
INSERT INTO feeds(name,userid,tag,datatype,public,engine) VALUES ('Consumo diario', @aux_id, 'Node:', '2','0','');
INSERT INTO feeds(name,userid,tag,datatype,public,engine) VALUES ('Energia FV a red diaria', @aux_id, 'Node:', '2','0','');
INSERT INTO feeds(name,userid,tag,datatype,public,engine) VALUES ('Porcentaje de autoconsumo diario',@aux_id,'Node:', '2','0','');
INSERT INTO feeds(name,userid,tag,datatype,public,engine) VALUES ('Porcentaje diario de consumo de origen FV',@aux_id,'Node:', '2','0','');
INSERT INTO feeds(name,userid,tag,datatype,public,engine) VALUES ('Energia consumo diario de FV',@aux_id,'Node:', '2','0','');

-- Sin engine ni datatype
INSERT INTO feeds(name,userid,tag,datatype,public,engine) VALUES ('Consumo total',@aux_id,'Node:','','0','');
INSERT INTO feeds(name,userid,tag,datatype,public,engine) VALUES ('Energia FV generada total',@aux_id,'Node:','','0','');
INSERT INTO feeds(name,userid,tag,datatype,public,engine) VALUES ('Energia total importada de la red', @aux_id, 'Node:','','0','');
INSERT INTO feeds(name,userid,tag,datatype,public,engine) VALUES ('Energia FV a consumo total', @aux_id, 'Node:', '','0','');
INSERT INTO feeds(name,userid,tag,datatype,public,engine) VALUES ('Energia FV inyectada a red total',@aux_id,'Node:', '','0','');

-- Inputs
INSERT into input (userid, name, description, nodeid, time, processList) 
VALUES (@aux_id, 'ipv','Intensidad fotovoltaica','',current_timestamp, '1:INTENSIDAD_FOTOVOLTAICA/*Log to Feed correspondiente(¿¿Potencia FV medida??)*/');

INSERT into input (userid, name, description, nodeid, time, processList) 
VALUES (@aux_id, 'ppvm','Potencia FV medida','',current_timestamp,
'47:15, /*If ppvm >= 15, skip next*/
33:0, /*Reset to 0*/
1:$feed_id(ppv), /*Log to feed ppv*/
5:$feed_id(ppv), /*A partir de ppv usando el engine Power to kWh/d */
1:$feed_id(eDPv), /*Log to feed eDPv*/
4:$feed_id(ppv),	/*A partir de ppv usando el engine Power to kWh*/
1:$feed_id(tPv), /*Log to feed tPv*/
33:0, /*Reset to 0*/
29:$feed_id(ppv), /*Sumas ppv, para dejarlo como ppv, como estaba al pincipio*/
25:0, /*Allow negative*/
22:$input_id(pload), /*ppv - pload (Problema porque creo que hay que predecir el id del input de pload sumando dos al de ppvm)*/
47:0, /*If (ppv - pload) >= 0, skip next*/
33:0, /*Reset to 0*/
1:$feed_id(IPvToNet) /*Log to IPvToNet*/
5:$feed_id(IPvToNet) /*A partir de IPvToNet usando el engine Power to kWh/d*/
1:$feed_id(eDPvToNet) /*Log to eDPvToNet*/
33:0, /*Reset to 0*/
29:$feed_id(eDPv), /*Sumas eDPv*/
30:$feed_id(eDPvToNet), /*Restas eDPvToNet*/
1:$feed_id(Log to eDLoadFromPv), /*Log to eDLoadFromPv*/
2:100, /*Por 100*/
32:$feed_id(eDPv), /*entre eDPv*/
1:$feed_id(dPSelf), /*Log to dPSelf*/
33:0, /*Reset to 0*/
29:$feed_id(eDLoadFromPv), /*Sumas eDLoadFromPv*/
2:100, /*Por 100*/
32:$feed_id(eDLoad), /*entre eDLoad*/
1:$feed_id(dPLoadFromPv) /*Log to dPLoadFromPv*/
');

INSERT into input (userid, name, description, nodeid, time, processList) 
VALUES (@aux_id, 'iload','Corriente consumo','',current_timestamp, '1:CORRIENTE_CONSUMO'/*Log to Feed correspondiente*/);

INSERT into input (userid, name, description, nodeid, time, processList) 
VALUES (@aux_id, 'pload','Potencia consumo','',current_timestamp,
5:$feed_id(pload) /*A partir de pload usando el engine Power to kWh/d*/
1:$feed_id(eDLoad), /*Log to feed eDLoad*/
4:$feed_id(pload)	/*A partir de pload usando el engine Power to kWh*/
1:$feed_id(tLoad), /*Log to feed eDLoad*/
37:0, /*Reset to Original, no veo otra forma de volver al input inicial, salvo sumar el input que estamos insertando*/
25:0, /*Allow negative*/
30:$feed_id(ppv), /*pload - ppv*/
46:0, /*If (pload - ppv) > 0, skip next*/
33:0, /*Reset to 0*/
1:$feed_id(iGridToLoad) /*Log to iGridToLoad, antes que iPvToLoad, es la unica forma que he visto de hacerlo secuencial*/
37:0, /*Reset to Original*/
30:$feed_id(iGridToLoad), /*Resto iGridToLoad para recuperar iPvToLoad*/
1:$feed_id(iPvToload), /*Log to iPvToLoad*/
2:100, /*Se multiplica por 100*/
12:$input_id(pload), /*Se divide entre pload*/
1:$feed_id(iPLoadFromPv), /*Log to iPLoadFromPv*/
33:0, /*Reset to 0*/
29:$feed_id(iGridToload), /*Se le suma el valor iGridToload para asignar ese valor*/
2:100, /*De nuevo, se multiplica por 100*/
12:$input_id(pload), /*Se divide entre pload*/
1:$feed_id(iPLoadFromNet), /*Log to iPLoadFromNet*/
33:0, /*Reset to 0*/
29:$feed_id(iGridToload), /*Se le suma el valor iGridToload para asignar ese valor*/
5:$feed_id(iGridToload) /*A partir de iGridToload usando el engine Power to kWh/d*/
1:$feed_id(eDNet), /*Log to feed eDNet*/
33:0, /*Reset to 0*/
29:$feed_id(iGridToload), /*Se le suma el valor iGridToload para asignar ese valor*/
4:$feed_id(iGridToload) /*A partir de iGridToload usando el engine Power to kWh*/
1:$feed_id(tLoadFromNet), /*Log to feed tLoadFromNet*/
33:0, /*Reset to 0*/
29:$feed_id(iPvToLoad), /*Se le suma el valor iPvToLoad para asignar ese valor*/
4:$feed_id(iPvToLoad) /*A partir de iPvToLoad usando el engine Power to kWh*/
1:$feed_id(tPvToLoad), /*Log to feed tPvToLoad*/
33:0, /*Reset to 0*/
29:$feed_id(tPv), /*Se le suma el valor tPv para asignar ese valor*/
30:$feed_id(tPvToLoad), /*Se le suma el valor tPvToLoad*/
1:$feed_id(tPvToNet) /*Log to feed tPvToNet*/
');

INSERT into input (userid, name, description, nodeid, time, processList) 
VALUES (@aux_id, 'voltaje','Voltaje','',current_timestamp, '1:$feed_id'(voltaje));


